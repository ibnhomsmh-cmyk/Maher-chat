<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maher Chat Pro | النسخة الكاملة</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <style>
        :root { --primary: #075e54; --secondary: #25d366; --bg: #efeae2; }
        * { box-sizing: border-box; font-family: sans-serif; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: var(--bg); }
        .app-shell { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { width: 30%; background: #fff; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { background: var(--primary); color: #fff; padding: 15px; font-weight: bold; }
        .user-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; position: relative; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .online { background: #25d366; }
        .offline { background: #bbb; }
        .typing-text { font-size: 11px; color: var(--secondary); display: none; }

        /* Chat Area */
        .chat-main { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .chat-header { background: #ededed; padding: 10px 15px; border-bottom: 1px solid #ccc; }
        #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .bubble { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: #fff; align-self: flex-start; }
        .msg-time { font-size: 9px; color: #888; margin-top: 4px; display: block; text-align: left; }

        .input-box { background: #f0f0f0; padding: 10px; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; border: none; padding: 12px; border-radius: 20px; outline: none; }

        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: #fff; padding: 30px; border-radius: 15px; text-align: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2>Maher Chat</h2>
        <button onclick="loginWithGoogle()" style="padding:10px 20px; cursor:pointer;">تسجيل الدخول عبر Google</button>
    </div>
</div>

<div class="app-shell">
    <div class="sidebar">
        <div class="sidebar-header">الأصدقاء</div>
        <div id="users-list"></div>
    </div>
    <div class="chat-main">
        <div class="chat-header">
            <div id="target-name" style="font-weight:bold;">اختر محادثة</div>
            <div id="target-status" style="font-size:12px; color:#666;"></div>
        </div>
        <div id="msg-area"></div>
        <div id="typing-indicator" style="padding:5px 20px; font-size:12px; color:var(--primary); font-style:italic; display:none;">جاري الكتابة...</div>
        <div class="input-box">
            <input type="text" id="msg-input" placeholder="اكتب رسالة..." oninput="handleTyping()">
            <button onclick="send()" style="border:none; background:none; font-size:20px; cursor:pointer;">➤</button>
        </div>
    </div>
</div>

<script>
    // إعدادات Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAJeNxCZKTRd8A8MHatwSErXVxcO1UVC5g",
        authDomain: "maher-chat-6fce8.firebaseapp.com",
        projectId: "maher-chat-6fce8",
        storageBucket: "maher-chat-6fce8.appspot.com",
        messagingSenderId: "643481245633",
        appId: "1:643481245633:web:927a11f2260bc8efb64140"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let selId = null;
    let typingTimeout;

    // تفعيل الحفظ التلقائي (العمل بدون إنترنت)
    db.enablePersistence().catch(() => console.log("Persistence disabled"));

    async function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            // تحديث حالة "متصل"
            db.collection("users").doc(user.uid).set({
                name: user.displayName,
                uid: user.uid,
                status: "online",
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // عند إغلاق التطبيق، تحويل الحالة إلى offline
            window.addEventListener('beforeunload', () => {
                db.collection("users").doc(user.uid).update({ status: "offline", lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
            });

            loadUsers();
        }
    });

    function loadUsers() {
        db.collection("users").onSnapshot(snap => {
            const list = document.getElementById('users-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if (u.uid !== auth.currentUser.uid) {
                    const div = document.createElement('div');
                    div.className = "user-item";
                    const isOnline = u.status === "online";
                    div.innerHTML = `
                        <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                        <strong>${u.name}</strong>
                        <div class="typing-text" id="typing-${u.uid}">يكتب الآن...</div>
                    `;
                    div.onclick = () => { 
                        selId = u.uid; 
                        document.getElementById('target-name').innerText = u.name;
                        document.getElementById('target-status').innerText = isOnline ? "متصل الآن" : "آخر ظهور: " + (u.lastSeen ? new Date(u.lastSeen.seconds*1000).toLocaleTimeString() : "غير معروف");
                        listen(); 
                    };
                    list.appendChild(div);
                }
            });
        });
    }

    // منطق "يكتب الآن"
    function handleTyping() {
        if (!selId) return;
        db.collection("users").doc(auth.currentUser.uid).update({ typingTo: selId });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            db.collection("users").doc(auth.currentUser.uid).update({ typingTo: null });
        }, 2000);
    }

    function send() {
        const t = document.getElementById('msg-input').value;
        if (!selId || !t.trim()) return;
        const cid = auth.currentUser.uid < selId ? auth.currentUser.uid+"_"+selId : selId+"_"+auth.currentUser.uid;
        db.collection("chats").doc(cid).collection("messages").add({
            text: t, sender: auth.currentUser.uid, time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msg-input').value = "";
        db.collection("users").doc(auth.currentUser.uid).update({ typingTo: null });
    }

    function listen() {
        const cid = auth.currentUser.uid < selId ? auth.currentUser.uid+"_"+selId : selId+"_"+auth.currentUser.uid;
        
        // مراقبة الرسائل
        db.collection("chats").doc(cid).collection("messages").orderBy("time").onSnapshot(snap => {
            const area = document.getElementById('msg-area');
            area.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                const v = document.createElement('div');
                v.className = `bubble ${m.sender === auth.currentUser.uid ? 'sent' : 'received'}`;
                const time = m.time ? new Date(m.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
                v.innerHTML = `${m.text} <span class="msg-time">${time}</span>`;
                area.appendChild(v);
            });
            area.scrollTop = area.scrollHeight;
        });

        // مراقبة هل الطرف الآخر يكتب لي؟
        db.collection("users").doc(selId).onSnapshot(doc => {
            const data = doc.data();
            const indicator = document.getElementById('typing-indicator');
            if (data.typingTo === auth.currentUser.uid) {
                indicator.style.display = "block";
            } else {
                indicator.style.display = "none";
            }
        });
    }
</script>
</body>
</html>
